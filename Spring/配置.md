[toc]

# 自动配置原理[^1] [^2] [^3]

## `@EnableAutoConfiguration`

自动配置的关键就是`@EnableAutoConfiguration`，`@EnableAutoConfiguration`是`@SpringBootApplication`的子注解。`@EnableAutoConfiguration`的作用就是扫描所有具有`META/spring.factories`的`jar`包。并且加载其中的同名自动配置类。

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@AutoConfigurationPackage
@Import(AutoConfigurationImportSelector.class)
public @interface EnableAutoConfiguration {....}
```

`@EnableAutoConfiguration`注解的关键是`@Import(AutoConfigurationImportSelector.class)`，导入`AutoConfigurationImportSelector` 。`AutoConfigurationImportSelector`类中的`selectImports()` 通过`SpringFactoriesLoader.loadFactoryNames()`扫描所有具有`META-INF/spring.factories`的jar包。并导入同名的自动配置类。

`spring.factories`是一组一组`key=value`的形式。其中一个key是`EnableAutoConfiguration`类的全类名，而它的value是一个`xxxxAutoConfiguration`的类名的列表。

## 自动配置类

**条件注解**

每一个`XxxxAutoConfiguration`自动配置类都是在某些条件之下才会生效的，这些条件的限制在Spring Boot中以注解的形式体现，常见的**条件注解**有如下几项：

> `@ConditionalOnBean`：当容器里有指定的bean的条件下。
>
> `@ConditionalOnMissingBean`：当容器里不存在指定bean的条件下。
>
> `@ConditionalOnClass`：当类路径下有指定类的条件下。
>
> `@ConditionalOnMissingClass`：当类路径下不存在指定类的条件下。
>
> `@ConditionalOnProperty`：指定的属性是否有指定的值，比如`@ConditionalOnProperties(prefix=”xxx.xxx”, value=”enable”, matchIfMissing=true)`，代表当`xxx.xxx`为`enable`时条件的布尔值为`true`，如果没有设置的情况下也为`true`

**`@ConfigurationProperties`**，它的作用就是从配置文件中绑定属性到对应的bean上。

而**`@EnableConfigurationProperties`**负责导入这个已经被`@ConfigurationProperties`绑定了属性的bean到spring容器中。同时`EnableConfigurationProperties` 绑定到自动配置类`XxxxAutoConfiguration`上。

以下Spring 加载配置的流程示意图

![](how-spring-boot-autoconfigure-works.png)[^3]

# 参考资料

[^1]:[Spring 常用的配置 官方文档](https://docs.spring.io/spring-boot/docs/2.1.0.RELEASE/reference/htmlsingle/#common-application-properties)

[^2]:[Spring Boot面试杀手锏————自动配置原理](https://blog.csdn.net/u014745069/article/details/83820511)

[^3]:[Spring Boot Rock’n’Roll](https://afoo.me/posts/2015-07-09-how-spring-boot-works.html)